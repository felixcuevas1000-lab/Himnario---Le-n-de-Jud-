<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé∂ Himnario Le√≥n de Jud√° | Alabanza y Adoraci√≥n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .debug-info {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
        }

        .search-add-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-box {
            flex: 1;
            padding: 15px 20px;
            font-size: 16px;
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 15px 25px;
            font-size: 16px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: #10b981;
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .filter-btn:hover, .filter-btn.active {
            background: white;
            color: #667eea;
            border-color: white;
        }

        .songs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .song-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .song-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .song-card h3 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.3em;
        }

        .song-card .artist {
            color: #6b7280;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .song-card .category {
            display: inline-block;
            background: #e0e7ff;
            color: #667eea;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-top: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-header h2 {
            color: #667eea;
            font-size: 1.8em;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6b7280;
        }

        .close-btn:hover {
            color: #dc2626;
        }

        .song-viewer {
            background: #f9fafb;
            padding: 30px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .song-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .transpose-controls, .font-size-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .transpose-controls span, .font-size-controls span {
            font-weight: 600;
            color: #374151;
        }

        .song-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            line-height: 1.8;
        }

        .chord {
            color: #dc2626;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: white;
        }

        .empty-state h2 {
            font-size: 2em;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            .songs-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé∂ Himnario | Ministerios Le√≥n de Jud√°</h1>
            <p>Alabanza y Adoraci√≥n</p>
        </div>

        <div class="debug-info" id="debugInfo">
            Cargando alabanzas desde Google Sheets... üé∂
        </div>

        <div class="search-add-container">
            <input type="text" class="search-box" id="searchInput" placeholder="üîç Buscar alabanza por nombre o artista...">
        </div>

        <div class="filters" id="filters"></div>
        <div class="songs-grid" id="songsGrid"></div>
    </div>

    <!-- Modal Ver -->
    <div class="modal" id="viewModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 id="viewSongName"></h2>
                    <p class="artist" id="viewSongArtist"></p>
                </div>
                <button class="close-btn" onclick="cerrarModalVer()">&times;</button>
            </div>
            
            <div class="song-controls">
                <div class="transpose-controls">
                    <button class="btn btn-secondary btn-small" onclick="transponer(-1)">‚ô≠ -1</button>
                    <span id="transposeValue">Tono: 0</span>
                    <button class="btn btn-secondary btn-small" onclick="transponer(1)">‚ôØ +1</button>
                    <button class="btn btn-secondary btn-small" onclick="resetearTono()">Reset</button>
                </div>
                
                <div class="font-size-controls">
                    <button class="btn btn-secondary btn-small" onclick="cambiarTamano(-2)">A-</button>
                    <span>Tama√±o</span>
                    <button class="btn btn-secondary btn-small" onclick="cambiarTamano(2)">A+</button>
                </div>
            </div>

            <div class="song-viewer">
                <div class="song-content" id="songContent"></div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="cerrarModalVer()">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let todasLasAlabanzas = [];
        let alabanzaActualId = null;
        let transposicion = 0;
        let tamanoFuente = 16;

        // URL de tu Google Sheet
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTdFW5M436XB-I9ME8blmBkMFrWO4d-7wqoS1MroFzv10kgsTGRkYOP3ZLSL4TOkH_G30t7RAfsTngw/pub?output=csv';

        // Cargar alabanzas desde Google Sheets
        async function cargarAlabanzas() {
            try {
                actualizarDebug('‚è≥ Cargando alabanzas...');
                
                const response = await fetch(GOOGLE_SHEET_URL);
                const csvText = await response.text();
                
                // Parsear CSV
                const lineas = csvText.split('\n');
                todasLasAlabanzas = [];
                
                // Saltar primera l√≠nea (encabezados)
                for (let i = 1; i < lineas.length; i++) {
                    const linea = lineas[i].trim();
                    if (!linea) continue;
                    
                    // Parsear CSV manualmente
                    const partes = parsearLineaCSV(linea);
                    
                    if (partes.length >= 5) {
                        todasLasAlabanzas.push({
                            id: partes[0],
                            name: partes[1],
                            artist: partes[2],
                            category: partes[3],
                            lyrics: partes[4]
                        });
                    }
                }
                
                actualizarDebug(`‚úÖ ${todasLasAlabanzas.length} alabanzas cargadas`);
                mostrarAlabanzas();
                mostrarFiltros();
                
            } catch (error) {
                console.error('Error:', error);
                actualizarDebug('‚ùå Error al cargar. Refresca la p√°gina');
            }
        }

        // Parsear l√≠nea CSV
        function parsearLineaCSV(linea) {
            const resultado = [];
            let campo = '';
            let dentroComillas = false;
            
            for (let i = 0; i < linea.length; i++) {
                const char = linea[i];
                
                if (char === '"') {
                    dentroComillas = !dentroComillas;
                } else if (char === ',' && !dentroComillas) {
                    resultado.push(campo.trim());
                    campo = '';
                } else {
                    campo += char;
                }
            }
            resultado.push(campo.trim());
            
            return resultado;
        }

        function actualizarDebug(msg) {
            document.getElementById('debugInfo').textContent = msg;
        }

        // Mostrar alabanzas
        function mostrarAlabanzas(filtro = null) {
            const grid = document.getElementById('songsGrid');
            const busqueda = document.getElementById('searchInput').value.toLowerCase();
            
            let alabanzas = todasLasAlabanzas;
            
            if (filtro) {
                alabanzas = alabanzas.filter(a => a.category === filtro);
            }
            
            if (busqueda) {
                alabanzas = alabanzas.filter(a => 
                    a.name.toLowerCase().includes(busqueda) || 
                    (a.artist && a.artist.toLowerCase().includes(busqueda))
                );
            }

            if (alabanzas.length === 0) {
                grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><h2>No hay alabanzas</h2></div>';
                return;
            }

            grid.innerHTML = alabanzas.map(a => `
                <div class="song-card" onclick="verAlabanza('${a.id}')">
                    <h3>${a.name}</h3>
                    ${a.artist ? `<div class="artist">${a.artist}</div>` : ''}
                    <div class="category">${a.category}</div>
                </div>
            `).join('');
        }

        function mostrarFiltros() {
            const categorias = [...new Set(todasLasAlabanzas.map(a => a.category))];
            const div = document.getElementById('filters');
            
            div.innerHTML = `
                <button class="filter-btn active" onclick="filtrar(null, this)">Todas (${todasLasAlabanzas.length})</button>
                ${categorias.map(cat => {
                    const n = todasLasAlabanzas.filter(a => a.category === cat).length;
                    return `<button class="filter-btn" onclick="filtrar('${cat}', this)">${cat} (${n})</button>`;
                }).join('')}
            `;
        }

        function filtrar(categoria, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            mostrarAlabanzas(categoria);
        }

        // Ver alabanza
        function verAlabanza(id) {
            const alabanza = todasLasAlabanzas.find(a => a.id === id);
            if (!alabanza) return;

            alabanzaActualId = id;
            transposicion = 0;
            tamanoFuente = 16;

            document.getElementById('viewSongName').textContent = alabanza.name;
            document.getElementById('viewSongArtist').textContent = alabanza.artist || '';
            document.getElementById('transposeValue').textContent = 'Tono: 0';
            
            mostrarContenido(alabanza.lyrics);
            document.getElementById('viewModal').classList.add('show');
        }

        function mostrarContenido(letra) {
            const div = document.getElementById('songContent');
            div.style.fontSize = tamanoFuente + 'px';
            
            const lineas = letra.split('\n');
            const procesadas = lineas.map(linea => {
                const tieneAcordes = /\b[A-G](#|b)?(m|maj|min|dim|aug|sus|add)?[0-9]?\b/.test(linea);
                const espacios = linea.replace(/\s/g, '').length;
                const total = linea.length;
                const esLineaAcordes = tieneAcordes && (total === 0 || espacios / total < 0.7);
                
                if (esLineaAcordes) {
                    return `<div class="chord">${transponerLinea(linea)}</div>`;
                }
                return linea;
            }).join('\n');
            
            div.innerHTML = procesadas;
        }

        function transponerLinea(linea) {
            const acordes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            return linea.replace(/\b([A-G](#|b)?(m|maj|min|dim|aug|sus|add)?[0-9]?)\b/g, (match) => {
                let raiz = match.match(/^[A-G](#|b)?/)[0];
                let sufijo = match.slice(raiz.length);
                
                raiz = raiz.replace('Db', 'C#').replace('Eb', 'D#')
                         .replace('Gb', 'F#').replace('Ab', 'G#').replace('Bb', 'A#');
                
                let idx = acordes.indexOf(raiz);
                if (idx === -1) return match;
                
                idx = (idx + transposicion + 12) % 12;
                return acordes[idx] + sufijo;
            });
        }

        function transponer(n) {
            transposicion += n;
            document.getElementById('transposeValue').textContent = `Tono: ${transposicion > 0 ? '+' : ''}${transposicion}`;
            const a = todasLasAlabanzas.find(x => x.id === alabanzaActualId);
            if (a) mostrarContenido(a.lyrics);
        }

        function resetearTono() {
            transposicion = 0;
            document.getElementById('transposeValue').textContent = 'Tono: 0';
            const a = todasLasAlabanzas.find(x => x.id === alabanzaActualId);
            if (a) mostrarContenido(a.lyrics);
        }

        function cambiarTamano(n) {
            tamanoFuente += n;
            tamanoFuente = Math.max(12, Math.min(28, tamanoFuente));
            document.getElementById('songContent').style.fontSize = tamanoFuente + 'px';
        }

        function cerrarModalVer() {
            document.getElementById('viewModal').classList.remove('show');
            alabanzaActualId = null;
        }

        // B√∫squeda
        document.getElementById('searchInput').addEventListener('input', () => mostrarAlabanzas());

        // Cerrar con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') cerrarModalVer();
        });

        // Recargar cada 2 minutos
        setInterval(cargarAlabanzas, 120000);

        // Iniciar
        cargarAlabanzas();
    </script>
</body>
</html>
